name: Build and Deploy to Production

on:
  push:
    branches: [ "main" ]

jobs:
  build-push-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    # ---------- Build Backend with Caching ----------
    - name: Set up Java
      uses: actions/setup-java@v4
      with:
        java-version: '25'
        distribution: 'temurin'
        cache: 'maven' # Automatically caches ~/.m2 dependencies

    - name: Build Backend
      working-directory: backend/content-service
      run: bash ./mvnw clean package -DskipTests

    - name: Build Auth Service
      working-directory: backend/auth-service
      run: bash ./mvnw clean package -DskipTests
      
    # ---------- Build Frontend with Caching ----------
    - name: Set up Node
      uses: actions/setup-node@v4
      with:
        node-version: 24
        cache: 'npm' # Automatically caches node_modules
        cache-dependency-path: frontend/package-lock.json

    - name: Build Frontend
      working-directory: frontend
      run: |
        npm ci
        npm run build

    # ---------- Docker Login & Setup ----------
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    # ---------- Modern Build & Push ----------
    - name: Build & Push content-service
      uses: docker/build-push-action@v5
      with:
        context: ./backend/content-service
        push: true
        tags: |
          adebayoyeleye/story-content-service:latest
          adebayoyeleye/story-content-service:${{ github.sha }}

    - name: Build & Push auth-service
      uses: docker/build-push-action@v5
      with:
        context: ./backend/auth-service
        push: true
        tags: |
          adebayoyeleye/auth-service:latest
          adebayoyeleye/auth-service:${{ github.sha }}
    


    - name: Build & Push Frontend
      uses: docker/build-push-action@v5
      with:
        context: ./frontend
        push: true
        tags: |
          adebayoyeleye/story-frontend:latest
          adebayoyeleye/story-frontend:${{ github.sha }}

    # ---------- Enhanced Deploy Script ----------
    - name: Deploy to Oracle Cloud VM
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.OCI_HOST }}
        username: ubuntu
        key: ${{ secrets.OCI_HOST_SSH_KEY }}
        script: |
          cd /home/ubuntu/app
          # Ensure latest images are present
          docker compose -f docker-compose.prod.yml pull
          # Force recreation to catch config file changes
          docker compose -f docker-compose.prod.yml up -d --force-recreate
          # Explicitly reload nginx to apply mapped nginx.conf updates
          docker compose exec -T nginx nginx -s reload
          # Cleanup old images to prevent disk fill-up
          docker image prune -f
